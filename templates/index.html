<!DOCTYPE html>
<html>
<head>
    <title>Calgary Council Stream Recorder</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @keyframes pulse-animation {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .pulse-dot {
            animation: pulse-animation 2s ease-in-out infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .loading-mini {
            display: inline-block;
            width: 10px;
            height: 10px;
            border: 2px solid #e5e7eb;
            border-top-color: #fbbf24;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
    </style>
    <script>
        // Auto-refresh every 10 seconds
        setTimeout(() => location.reload(), 10000);

        async function stopRecording() {
            if (!confirm('Are you sure you want to stop the current recording?')) {
                return;
            }

            const button = document.getElementById('stop-button');
            button.disabled = true;
            button.textContent = 'Stopping...';

            try {
                const response = await fetch('/api/stop-recording', {
                    method: 'POST'
                });
                const result = await response.json();

                if (result.success) {
                    alert('Recording stop requested. The recording will end shortly.');
                    location.reload();
                } else {
                    alert('Failed to stop recording: ' + (result.error || 'Unknown error'));
                    button.disabled = false;
                    button.textContent = 'Stop Recording';
                }
            } catch (error) {
                alert('Error: ' + error.message);
                button.disabled = false;
                button.textContent = 'Stop Recording';
            }
        }

        async function refreshAgenda() {
            const button = document.getElementById('refresh-agenda-button');
            button.disabled = true;
            button.textContent = 'Refreshing...';

            try {
                const response = await fetch('/api/refresh-agenda', {
                    method: 'POST'
                });
                const result = await response.json();

                if (result.success) {
                    alert(result.message);
                    location.reload();
                } else {
                    alert('Failed to refresh agenda: ' + (result.error || 'Unknown error'));
                    button.disabled = false;
                    button.textContent = 'üîÑ Refresh Agenda';
                }
            } catch (error) {
                alert('Error: ' + error.message);
                button.disabled = false;
                button.textContent = 'üîÑ Refresh Agenda';
            }
        }

        async function startMonitoring() {
            const button = document.getElementById('start-monitoring-button');
            button.disabled = true;
            button.textContent = 'Starting...';

            try {
                const response = await fetch('/api/monitoring/start', {
                    method: 'POST'
                });
                const result = await response.json();

                if (result.success) {
                    location.reload();
                } else {
                    alert('Failed to start monitoring: ' + (result.error || 'Unknown error'));
                    button.disabled = false;
                    button.textContent = '‚ñ∂Ô∏è Start Monitoring';
                }
            } catch (error) {
                alert('Error: ' + error.message);
                button.disabled = false;
                button.textContent = '‚ñ∂Ô∏è Start Monitoring';
            }
        }

        async function stopMonitoring() {
            const button = document.getElementById('stop-monitoring-button');
            button.disabled = true;
            button.textContent = 'Stopping...';

            try {
                const response = await fetch('/api/monitoring/stop', {
                    method: 'POST'
                });
                const result = await response.json();

                if (result.success) {
                    location.reload();
                } else {
                    alert('Failed to stop monitoring: ' + (result.error || 'Unknown error'));
                    button.disabled = false;
                    button.textContent = '‚è∏Ô∏è Stop Monitoring';
                }
            } catch (error) {
                alert('Error: ' + error.message);
                button.disabled = false;
                button.textContent = '‚è∏Ô∏è Stop Monitoring';
            }
        }

        async function cleanupStaleRecordings() {
            // First, get stale recordings count
            try {
                const countResponse = await fetch('/api/recordings/stale');
                const countResult = await countResponse.json();

                if (countResult.count === 0) {
                    alert('No stale recordings found!');
                    return;
                }

                if (!confirm(`Found ${countResult.count} stale recording(s). Delete them all?`)) {
                    return;
                }

                const button = document.getElementById('cleanup-stale-button');
                button.disabled = true;
                button.innerHTML = 'Cleaning up...';

                const response = await fetch('/api/recordings/stale/cleanup', {
                    method: 'POST'
                });
                const result = await response.json();

                if (result.success) {
                    alert(`Successfully deleted ${result.deleted_count} stale recording(s)`);
                    location.reload();
                } else {
                    alert('Failed to cleanup stale recordings: ' + (result.error || 'Unknown error'));
                    button.disabled = false;
                    button.innerHTML = 'üóëÔ∏è Clean Up Stale';
                }
            } catch (error) {
                alert('Error: ' + error.message);
                const button = document.getElementById('cleanup-stale-button');
                button.disabled = false;
                button.innerHTML = 'üóëÔ∏è Clean Up Stale';
            }
        }
    </script>
</head>
<body class="bg-gradient-to-br from-indigo-500 to-purple-600 min-h-screen p-5">
    <div class="max-w-6xl mx-auto">
        <!-- Header -->
        <div class="bg-white rounded-xl p-8 mb-5 shadow-lg flex flex-col md:flex-row justify-between items-center gap-4">
            <div>
                <h1 class="text-gray-800 text-3xl md:text-4xl font-bold mb-2">Calgary Council Stream Recorder</h1>
                <p class="text-gray-600 text-lg">Real-time monitoring and recording of Calgary City Council meetings</p>
            </div>
            <a href="/recordings" class="text-indigo-600 font-semibold px-4 py-2 rounded-lg hover:bg-gray-50 transition whitespace-nowrap">
                üìπ View All Recordings
            </a>
        </div>

        <!-- Current Status Card -->
        <div class="bg-white rounded-xl p-6 mb-5 shadow-lg">
            <div class="flex justify-between items-center mb-4 pb-3 border-b-2 border-gray-200">
                <h2 class="text-gray-800 text-2xl font-bold">Current Status</h2>
                <div class="flex gap-2">
                    {% if monitoring_enabled %}
                        <button id="stop-monitoring-button" onclick="stopMonitoring()" class="bg-orange-600 hover:bg-orange-700 text-white font-semibold px-4 py-2 rounded-lg transition disabled:bg-gray-400 disabled:cursor-not-allowed text-sm">
                            ‚è∏Ô∏è Stop Monitoring
                        </button>
                    {% else %}
                        <button id="start-monitoring-button" onclick="startMonitoring()" class="bg-green-600 hover:bg-green-700 text-white font-semibold px-4 py-2 rounded-lg transition disabled:bg-gray-400 disabled:cursor-not-allowed text-sm">
                            ‚ñ∂Ô∏è Start Monitoring
                        </button>
                    {% endif %}
                </div>
            </div>
            {% if current_recording %}
                <div class="inline-flex items-center gap-2 px-4 py-2 rounded-full bg-red-100 text-red-700 font-semibold text-sm">
                    <span class="w-2.5 h-2.5 rounded-full bg-red-700 pulse-dot"></span>
                    RECORDING IN PROGRESS
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
                    <div class="bg-gray-50 p-4 rounded-lg border-l-4 border-indigo-600">
                        <div class="text-gray-600 text-sm mb-1">Recording Since</div>
                        <div class="text-gray-800 text-xl font-bold">{{ current_recording.start_time }}</div>
                    </div>
                    <div class="bg-gray-50 p-4 rounded-lg border-l-4 border-indigo-600">
                        <div class="text-gray-600 text-sm mb-1">Meeting</div>
                        <div class="text-gray-800 text-base font-bold">{{ current_recording.meeting_title or 'Unscheduled' }}</div>
                    </div>
                </div>
                <button id="stop-button" onclick="stopRecording()" class="mt-4 bg-red-600 hover:bg-red-700 text-white font-semibold px-5 py-2 rounded-lg transition disabled:bg-gray-400 disabled:cursor-not-allowed">
                    Stop Recording
                </button>
            {% else %}
                {% if monitoring_enabled %}
                    <div class="inline-flex items-center gap-2 px-4 py-2 rounded-full bg-green-100 text-green-700 font-semibold text-sm">
                        <span class="w-2.5 h-2.5 rounded-full bg-green-700 pulse-dot"></span>
                        MONITORING
                    </div>
                    <p class="mt-4 text-gray-600">System is actively monitoring for live streams</p>
                {% else %}
                    <div class="inline-flex items-center gap-2 px-4 py-2 rounded-full bg-gray-100 text-gray-700 font-semibold text-sm">
                        <span class="w-2.5 h-2.5 rounded-full bg-gray-500"></span>
                        MONITORING DISABLED
                    </div>
                    <p class="mt-4 text-gray-600">Click "Start Monitoring" to begin watching for live streams</p>
                {% endif %}
            {% endif %}
        </div>

        <!-- Recording Statistics Card -->
        <div class="bg-white rounded-xl p-6 mb-5 shadow-lg">
            <div class="flex justify-between items-center mb-4 pb-3 border-b-2 border-gray-200">
                <h2 class="text-gray-800 text-2xl font-bold">Recording Statistics</h2>
                <button id="cleanup-stale-button" onclick="cleanupStaleRecordings()" class="bg-red-600 hover:bg-red-700 text-white font-semibold px-4 py-2 rounded-lg transition disabled:bg-gray-400 disabled:cursor-not-allowed text-sm">
                    üóëÔ∏è Clean Up Stale
                </button>
            </div>
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                <div class="bg-gray-50 p-4 rounded-lg border-l-4 border-indigo-600">
                    <div class="text-gray-600 text-sm mb-1">Total Recordings</div>
                    <div class="text-gray-800 text-3xl font-bold">{{ stats.total_recordings }}</div>
                </div>
                <div class="bg-gray-50 p-4 rounded-lg border-l-4 border-indigo-600">
                    <div class="text-gray-600 text-sm mb-1">Completed</div>
                    <div class="text-gray-800 text-3xl font-bold">{{ stats.completed }}</div>
                </div>
                <div class="bg-gray-50 p-4 rounded-lg border-l-4 border-indigo-600">
                    <div class="text-gray-600 text-sm mb-1">Failed</div>
                    <div class="text-gray-800 text-3xl font-bold">{{ stats.failed }}</div>
                </div>
                <div class="bg-gray-50 p-4 rounded-lg border-l-4 border-indigo-600">
                    <div class="text-gray-600 text-sm mb-1">Total Size</div>
                    <div class="text-gray-800 text-3xl font-bold">{{ stats.total_size_gb }} GB</div>
                </div>
            </div>
        </div>

        <!-- Upcoming Meetings Card -->
        <div class="bg-white rounded-xl p-6 mb-5 shadow-lg">
            <div class="flex justify-between items-center mb-4 pb-3 border-b-2 border-gray-200">
                <h2 class="text-gray-800 text-2xl font-bold">Upcoming Meetings</h2>
                <button id="refresh-agenda-button" onclick="refreshAgenda()" class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold px-4 py-2 rounded-lg transition disabled:bg-gray-400 disabled:cursor-not-allowed text-sm">
                    üîÑ Refresh Agenda
                </button>
            </div>
            {% if meetings %}
                <ul class="space-y-2">
                    {% for meeting in meetings %}
                    <li class="p-4 bg-gray-50 rounded-lg border-l-4 border-indigo-600">
                        <div class="text-gray-800 font-semibold mb-1">{{ meeting.title }}</div>
                        <div class="text-gray-600 text-sm">{{ meeting.raw_date }}</div>
                    </li>
                    {% endfor %}
                </ul>
            {% else %}
                <div class="text-center py-10 text-gray-500">
                    <p>No upcoming meetings scheduled</p>
                </div>
            {% endif %}
        </div>

        <!-- Recent Recordings Card -->
        <div class="bg-white rounded-xl p-6 mb-5 shadow-lg">
            <h2 class="text-gray-800 text-2xl font-bold mb-4 pb-3 border-b-2 border-gray-200">Recent Recordings</h2>
            {% if recordings %}
                {% for recording in recordings %}
                <div class="p-4 mb-2 bg-gray-50 rounded-lg flex flex-col sm:flex-row justify-between items-start sm:items-center gap-3">
                    <div class="flex-1">
                        <div class="text-gray-800 font-semibold mb-1">{{ recording.meeting_title or 'Council Meeting' }}</div>
                        <div class="text-gray-600 text-sm">
                            {{ recording.start_time }}
                            {% if recording.duration_seconds %}
                                ‚Ä¢ Duration: {{ recording.duration_minutes }} min
                            {% endif %}
                            {% if recording.file_size_mb %}
                                ‚Ä¢ Size: {{ recording.file_size_mb }} MB
                            {% endif %}
                        </div>
                    </div>
                    <div class="flex flex-wrap gap-2 items-center">
                        <span class="px-3 py-1 rounded-full text-xs font-semibold
                            {% if recording.status == 'completed' %}bg-green-100 text-green-700
                            {% elif recording.status == 'failed' %}bg-red-100 text-red-700
                            {% else %}bg-orange-100 text-orange-700{% endif %}">
                            {{ recording.status.upper() }}
                        </span>

                        <!-- Post-processing indicator for completed recordings -->
                        {% if recording.status == 'completed' %}
                            {% set pp_status = recording.post_process_status or 'pending' %}
                            {% if pp_status == 'completed' %}
                                <span class="text-xs text-blue-600 inline-flex items-center gap-1">
                                    <span class="w-1.5 h-1.5 rounded-full bg-blue-500"></span>
                                    <span>Processed</span>
                                </span>
                            {% elif pp_status == 'processing' %}
                                <span class="text-xs text-yellow-600 inline-flex items-center gap-1">
                                    <span class="loading-mini"></span>
                                    <span>Processing...</span>
                                </span>
                            {% elif pp_status == 'failed' %}
                                <span class="text-xs text-red-600 inline-flex items-center gap-1">
                                    <span>‚ö†Ô∏è</span>
                                    <span>PP Failed</span>
                                </span>
                            {% else %}
                                <span class="text-xs text-gray-500 inline-flex items-center gap-1">
                                    <span class="w-1.5 h-1.5 rounded-full bg-gray-400"></span>
                                    <span>Not processed</span>
                                </span>
                            {% endif %}
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            {% else %}
                <div class="text-center py-10 text-gray-500">
                    <p>No recordings yet</p>
                </div>
            {% endif %}
        </div>

        <!-- Footer -->
        <div class="text-right text-gray-100 text-sm mt-3">
            Page auto-refreshes every 10 seconds ‚Ä¢ Last updated: {{ now }}
        </div>
    </div>
</body>
</html>
